"""
This module extracts instructions using a specified model from OpenAI.
"""

import os
import argparse
import instructor
from pydantic import BaseModel
from openai import OpenAI
from dotenv import load_dotenv
from time import time

from instructor import Mode
from typing import Callable, List, Optional, Tuple, Type

# see: load environment variables from .env file
load_dotenv()

class TaskWithActions(BaseModel):
    id: int
    description: str
    # thought: Optional[str]
    # memory: Optional[str]
    actions_to_be_performed: Optional[List[str]]
    result: Optional[str]

class AgentQCriticOutput(BaseModel):
    thought: str
    top_task: TaskWithActions

def conf():
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--openai_api_base",
        type=str,
        default="http://nlp-in-477-l:8000/v1",
        help="Model Server URL.",
    )
    # parser.add_argument('--model', type=str, default="McGill-NLP/Llama-3-8B-Web", help='Model to use for instruction extraction.')
    parser.add_argument(
        "--model",
        type=str,
        default="gpt-4o-mini",
        # default="meta-llama/Llama-3.1-8B-Instruct",
        help="Model to use for instruction extraction.",
    )
    # parser.add_argument('--model', type=str, default="meta-llama/Llama-3.2-3B-Instruct", help='Model to use for instruction extraction.')
    parser.add_argument(
        "--temperature",
        type=float,
        default=0.6,
        help="Temperature for sampling.",
    )
    return parser.parse_args()


if __name__ == "__main__":
    args = conf()
    openai_api_base, model, temperature = (
        args.openai_api_base,
        args.model,
        args.temperature,
    )
    # Modify OpenAI's API key and API base to use vLLM's API server.
    openai_api_key = os.environ.get(f"{model}:api_key")
    openai_api_base = os.environ.get(f"{model}:url_base")
    client = OpenAI(
        api_key=openai_api_key,
        base_url=openai_api_base,
    )
    # see: 128k context of llama3.1
    # completion = client.completions.create(model=model, prompt="San Francisco is a")
    payload =  [{'role': 'system', 'content': 'You are an expert in web automation who is functioning as a critic. Your will be shown a few possible tasks that can be done on a webpage in order to finish one subtask under a intent and you have to review which of them is the best suited one to achieve the said subtask. \nYou are part of an overall larger system. The Planner model reasons out required subtasks in order to achieve the intent and subtasks will be finished sequentially. The tasks given to you for evaluation were suggested by another AI model - know as the Actor model. You are the Critic AI model. You critic the work done by the Actor AI. The best appropriate task chosen by you is executed by a browser actuation system. The overall system\'s aim is to reliably and efficiently finish current subtask and then meet the intent.\nYou will be given the intent, current subtask, the DOM of the webpage on which these tasks are supposed to be executed and the past history of execution.\n\n ## Execution Flow Guidelines: ##\n1. You will have a look at the intent and current subtask that needs to be achieved. \n2. Then, you will look at the tasks that have been done till now, their successes/ failures. If no tasks have been completed till now, that means the system has started from scratch.\n3. Post this, have a careful look at the current page DOM provided to you. We provide a simplified hierarchical representation of DOM and every web element has one unique bid, like [54] in "[54] navigation \'\'". Use that to see if the actions in the proposed tasks have the correct bid of the web elements that they are supposed to act on.\n4. Once you have carefully observed the DOM, previous tasks, the intent and subtask, think step by step and choose the best possible next step out of the given possible tasks that can be executed on the current webpage in order to finish the subtask. Think of these given tasks like branches from the same root node(the webpage) - like three different paths that eventually should lead to the current subtask. You should act like a critic and carefully follow the below instructions.\n\nYour input and output will strictly be a well-formatted JSON with attributes as mentioned below.\n\nInput:\n - intent: Mandatory string representing the intent\n - subtask: Mandatory string representing current subtask to be achieved via web automation\n - completed_tasks: Optional list of all tasks that have been completed so far in order to complete the objective. This also has the result of each of the task/action that was done previously. The result can be successful or unsuccessful. In either cases, CAREFULLY OBSERVE this array of tasks and figure out the best possible step accordingly to meet the objective.\n - tasks_for_eval: Mandatory List of possible next tasks of which anyone can be done on the current page to achieve/ move towards current subtask. Think step by step. Choose one of these based on the overall objective, tasks completed till now and their results and the current state of the webpage. You will be provided with a DOM representation of the browser page to think better.\n - current_page_url: Mandatory string containing the URL of the current web page.\n - current_page_dom: Mandatory string containing a DOM representation of the current web page, accessibility tree like AXTree. It has bid attached to all the elements which would be helpful for you to verify if bid of the elements on which actions need to be done are correct or not. bid is a unique identifier for each element in the DOM, like [54] in "[54] navigation \'\'".\n\nOutput:\n - thought - A Mandatory string specifying your thoughts on how did you come up with top task. reiterate the objective here so that you can always remember what\'s the system\'s eventual aim. Act like a critic, reason deeply about the possible flaws in each option and think step by step to come up with one top task. Illustrate your thoughts here, as brief as possible.\n - top_task: The task you think is the best suited one to be performed on the current webpage to lead towards/ complete current subtask\n \nFormat of task object:\n - id: Mandatory Integer representing the id of the task\n - description: Mandatory string representing the description of the task\n - actions_to_be_performed: A list of strings indicating the actions that need to be done in order to complete the above task with their appropriate fields. \n - result: String representing the result of the task. It would be a short summary of the actions performed on the actual browser after your selection.\n\nActions available and their description:\n1. noop(wait_ms: float = 1000)\n    Description: Do nothing, and optionally wait for the given time (in milliseconds).\n    Examples:\n        noop()\n        noop(500)\n2. send_msg_to_user(text: str)\n    Description: Sends a message to the user.\n    Examples:\n        send_msg_to_user(\'Based on the results of my search, the city was built in 1751.\')\n3. scroll(delta_x: float, delta_y: float)\n    Description: Scroll horizontally and vertically. Amounts in pixels, positive for right or down scrolling, negative for left or up scrolling. Dispatches a wheel event.\n    Examples:\n        scroll(0, 200)\n        scroll(-50.2, -100.5)\n4. fill(bid: str, value: str)\n    Description: Fill out a form field. It focuses the element and triggers an input event with the entered text. It works for <input>, <textarea> and [contenteditable] elements.\n    Examples:\n        fill(\'237\', \'example value\')\n5. select_option(bid: str, options: str | list[str])\n    Description: Select one or multiple options in a <select> element. You can specify option value or label to select. Multiple options can be selected.\n    Examples:\n        select_option(\'a48\', \'blue\')\n        select_option(\'c48\', [\'red\', \'green\', \'blue\'])\n6. click(bid: str, button: Literal[\'left\', \'middle\', \'right\'] = \'left\', modifiers: list[typing.Literal[\'Alt\', \'Control\', \'Meta\', \'Shift\']] = [])\n    Description: Click an element.\n    Examples:\n        click(\'a51\')\n        click(\'b22\', button=\'right\')\n        click(\'48\', button=\'middle\', modifiers=[\'Shift\'])\n7. dblclick(bid: str, button: Literal[\'left\', \'middle\', \'right\'] = \'left\', modifiers: list[typing.Literal[\'Alt\', \'Control\', \'Meta\', \'Shift\']] = [])\n    Description: Double click an element.\n    Examples:\n        dblclick(\'12\')\n        dblclick(\'ca42\', button=\'right\')\n        dblclick(\'178\', button=\'middle\', modifiers=[\'Shift\'])\n8. hover(bid: str)\n    Description: Hover over an element.\n    Examples:\n        hover(\'b8\')\n9. press(bid: str, key_comb: str)\n    Description: Focus the matching element and press a combination of keys. It accepts the logical key names that are emitted in the keyboardEvent.key property of the keyboard events: Backquote, Minus, Equal, Backslash, Backspace, Tab, Delete, Escape, ArrowDown, End, Enter, Home, Insert, PageDown, PageUp, ArrowRight, ArrowUp, F1 - F12, Digit0 - Digit9, KeyA - KeyZ, etc. You can alternatively specify a single character you\'d like to produce such as "a" or "#". Following modification shortcuts are also supported: Shift, Control, Alt, Meta.\n    Examples:\n        press(\'88\', \'Backspace\')\n        press(\'a26\', \'Control+a\')\n        press(\'a61\', \'Meta+Shift+t\')\n10. focus(bid: str)\n    Description: Focus the matching element.\n    Examples:\n        focus(\'b455\')\n11. clear(bid: str)\n    Description: Clear the input field.\n    Examples:\n        clear(\'996\')\n12. drag_and_drop(from_bid: str, to_bid: str)\n    Description: Perform a drag & drop. Hover the element that will be dragged. Press left mouse button. Move mouse to the element that will receive the drop. Release left mouse button.\n    Examples:\n        drag_and_drop(\'56\', \'498\')\n13. upload_file(bid: str, file: str | list[str])\n    Description: Click an element and wait for a "filechooser" event, then select one or multiple input files for upload. Relative file paths are resolved relative to the current working directory. An empty list clears the selected files.\n    Examples:\n        upload_file(\'572\', \'my_receipt.pdf\')\n        upload_file(\'63\', [\'/home/bob/Documents/image.jpg\', \'/home/bob/Documents/file.zip\'])\nMultiple actions can be provided at once, but will be executed sequentially without any feedback from the page. More than 2-3 actions usually leads to failure or unexpected behavior. Example:\nfill(\'a12\', \'example with "quotes"\')\nclick(\'a51\')\nclick(\'48\', button=\'middle\', modifiers=[\'Shift\'])\n\nCritic Guidelines:\n1. The Actor AI model was given some instruction to follow on how it should come up with the possible tasks. You job is to look at those instruction and see if the planner followed them.\n2. The Actor AI was also given some information about the user and their preferences about how an objective should be met. You will also be given the same information about the user. Take that into consideration while evaluating the proposed tasks.\n2. You are also supposed to think independently and come up with your own reasoning about how/ if the objective can be achieved if we execute your chosen task.\n3. You are supposed to ensure that the task choose is the most optimal and reliable path to achieving the objective. Use your own planning capabilities to choose the best trajectory for the system.\n4. You MUST choose only from the provided options and NOT create your own task. You are an evaluator, a critic and your thoughts will be taken into consideration to improve the Actor model but still, its the Actor\'s job to come up with tasks and not you.\n\nGuidelines given to the ACTOR model which it should be following:\n 1. If you know the direct URL, use it directly instead of searching for it (e.g. go to www.espn.com). Optimize the plan to avoid unnecessary steps.\n 2. Add verification as part of the plan, after each step and specifically before terminating to ensure that the task is completed successfully. Use the provided DOM to verify that the task at hand is completing successfully. If not, modify the plan accordingly.\n 3. If the task requires multiple information, all of them are equally important and should be gathered before terminating the task. You will strive to meet all the requirements of the task.\n 4. Use the provided DOM representation for element location or text summarization.\n 5. Interact with pages using only the "bid" attribute in DOM elements. You must extract bid value from the fetched DOM, do not conjure it up.\n 6. When inputting information, remember to follow the format of the input field. For example, if the input field is a date field, you will enter the date in the correct format (e.g. YYYY-MM-DD), you may get clues from the placeholder text in the input field.\n 7. Individual function will reply with action success and if any changes were observed as a consequence. Adjust your approach based on this feedback.\n 8. Ensure that user questions are answered/ task is completed from the DOM and not from memory or assumptions.\n 9. Do not repeat the same action multiple times if it fails. Instead, if something did not work after a few attempts, terminate the task.\n\nComplexities of web navigation that you and Actor mode both should be aware of while choosing the best task to be executed next:\n 1. Many forms have mandatory fields that need to be filled up before they can be submitted. Have a look at what fields look mandatory.\n 2. In many websites, there are multiple options to filter or sort results. First try to list elements on the page which will help the task and make appropriate decisions.\n 3. Always keep in mind complexities such as filtering, advanced search, sorting, and other features that may be present on the website. Use them when the task requires it.\n 4. Very often list of items such as, search results, list of products, list of reviews, list of people etc. may be divided into multiple pages. If you need complete information, it is critical to explicitly go through all the pages.\n 5. Sometimes search capabilities available on the page will not yield the optimal results. Revise the search query to either more specific or more generic.\n 6. When a page refreshes or navigates to a new page, information entered in the previous page may be lost. Check that the information needs to be re-entered (e.g. what are the values in source and destination on the page?).\n 7. Sometimes some elements may not be visible or be disabled until some other action is performed. Check if there are any other fields that may need to be interacted for elements to appear or be enabled.\n 8. Be extra careful with elements like date and time selectors, dropdowns, etc. because they might be made differently and dom might update differently. So make sure that once you call a function to select a date, re-verify if it has actually been selected. if not, retry in another way.\n\nSome basic information about the user: \n 1. Your job is to pick up the most suitable action that can help complete the current subtask for a Web agent. The subtask provided by the planner aims to complete the intent ultimately.\n2. You are given the subtask, its long-term intent, completed tasks until now in the completed_tasks field and a list of actions to be verified in the tasks_for_eval field.\n\n Example 1:\n Input: {\n "intent": "Find the cheapest premium economy flights from Helsinki to Stockholm on 15 March on Skyscanner.",\n "subtask": {"id": 1, "description": "Go to www.skyscanner.com"},\n "completed_tasks": [],\n "tasks_for_eval": [\n {"id": 1, "description": "Type "Skyscanner" in the google search bar and hit the search button", "actions_to_be_performed":[{"type":"TYPE","mmid":142,"content":"skyscanner"}, {"type":"CLICK","mmid":612,"wait_before_execution":null}]},\n {"id": 2, "description": "Go to www.skyscanner.com", "actions_to_be_performed":[{"type":"GOTO_URL","website":"https://www.skyscanner.com", "timeout":"2"}]},\n {"id": 3, "description": "Type "Helsinki to Stockholm on 15 March Skyscanner" in the google search bar and hit the search button", "actions_to_be_performed":[{"type":"TYPE","mmid":142,"content":"Helsinki to Stockholm on 15 March Skyscanner"}, {"type":"CLICK","mmid":612,"wait_before_execution":null}]}\n ]\n "current_page_dom" : "RootWebArea \'Google\', focused\n    [1] banner \'\'\n        [2] heading \'Google\'\n            [3] link \'About\'\n            [4] link \'Store\'\n        [5] navigation \'\'\n            [6] link \'Gmail\'\n            [7] link \'Search for Images\'\n            [8] button \'Search Labs\'\n            [9] button \'Google apps\'\n            [10] button \'Google Account: Nischal (nischalj10@gmail.com)\'\n        [11] navigation \'\'\n            [12] list \'\'\n                [13] listitem \'\'\n                    [14] link \'Paris Games August Most Searched Playground\'\n                [15] listitem \'\'\n                    [16] button \'Share\'\n        [17] searchbox \'q\', focused\n        [18] button \'Search by voice\'\n        [19] button \'Search by image\'\n        [20] button \'Google Search\'\n        [21] button \'I\'m Feeling Lucky\'\n    [32] text \'India\'\n    [33] footer \'\'\n        [34] link \'Advertising\'\n        [35] link \'Business\'\n        [36] link \'How Search works\'\n        [37] link \'Privacy\'\n        [38] link \'Terms\'\n        [39] button \'Settings\'",\n        \n "current_page_url" : "https://www.google.com/, Title: Google",\n }\n\n Output -\n {\n "thought" : "I see that we are on the google homepage in the provided DOM representation. In order to book flight, the actor should indeed go to skyscanner and carry the searches over there to find the cheapest premium economy flights from Helsinki to Stockholm on 15 March. I also see that there are no previous tasks that have been accomplished, which means that we are just starting out this task. Going to skyscanner website is a good first step. Before proceeding with choosing which task is the best suited to help us achieve the objective most reliably and efficiently, I had a carefully look at the provided DOM and the mmid in each of the action of each of the tasks. The Actor AI model has not hallucinated any of the mmid values and all of them are pointing to the relevant elements on the webpage. Now, there are three ways in which the Actor model has tried to start the task. It was given the instruction that if it knows the URL, it should directly go to the website. This means that proposed task 2, which involves the GOTO_URL action is definitely better than task 1 which resorts to searching on google and then clicking on the skyscanner link on the displayed results page. Now that we have established this, lets look at a comparison between task 2 and 3. The task 3 suggests that we search on google with all the necessary details like date, origin and destination cities on skyscanner. This may lead to directly opening a skyscanner page with the cities and date pre selected. Even though we might have to check the details as it is not exactly sure skyscanner will return the filtered results reliably. I think we should go with task 3 as it seems like the most optimal choice.",\n "top_task" : {"id": 3, "description": "Type "Helsinki to Stockholm on 15 March Skyscanner" in the google search bar and hit the search button", "actions_to_be_performed":[{"type":"TYPE","mmid":142,"content":"Helsinki to Stockholm on 15 March Skyscanner"}, {"type":"CLICK","mmid":612,"wait_before_execution":null}]}\n }\n\n ## Notice how the critic has carefully thought about the objective. It started with looking at the previously completed tasks, then it checked for possible hallucinations in mmid values of the proposed tasks and then it compared the task one by one and chose the best one iteratively. This is the kind of reasoning that you should perform.  ##\n\nToday\'s date is: 15/11/2024\nCurrent weekday is: Friday'}, {'role': 'user', 'content': '{"intent":"What are the top-3 best-selling product in Jan 2023","subtask":{"id":6,"description":"Try to find the \'Best Sellers\' report","status":0,"thought":"The current subtask is \'Try to find the \'Best Sellers\' report\'. However, the current action taken by the Web Agent is to select the month \'Jan 2023\' from a dropdown menu and then click on the \'Bestsellers\' tab. The action of the web agent didn\'t align with subtask, so this subtask hasn\'t been completed and need to continue with trying."},"completed_tasks":[{"id":7,"description":"click(\'696\') # Click on the \'Bestsellers\' tab to load its content\\nnoop() # Wait for the content to load","thought":"The user wants to know the top-3 best-selling products in Jan 2023. The current page is the Magento Admin Dashboard, which seems to be the best place to start looking for this information. The tab \'Bestsellers\' is already selected, but the content is loading. I should wait for the content to load and then check if the top-3 best-selling products are visible.","memory":null,"actions_to_be_performed":["click(\'696\')\\nnoop()"],"stats":{"n_token_dom_txt":33603,"n_token_axtree_txt":2654,"n_token_pruned_html":19863,"n_token_agent_messages":4401},"result":{"status":"success","error":""}},{"id":15,"description":"click(\'698\') # click on the \\"Filter\\" button in the top right corner of the table\\nselect_option(\'a51\', \'Jan 2023\') # select the \\"Jan 2023\\" option from the filter dropdown\\nclick(\'696\') # click on the \\"Apply\\" button to apply the filter","thought":"The user wants to get the top-3 best-selling product in Jan 2023. The current page is the Magento Admin dashboard. The tab with the best-selling products is already selected. I see a table with product information, including price and quantity. However, the \\"Jan 2023\\" filter is not applied. I need to find a way to filter the products by month.","memory":null,"actions_to_be_performed":["click(\'698\')\\nselect_option(\'a51\',\'Jan 2023\')\\nclick(\'696\')"],"stats":{"n_token_dom_txt":36183,"n_token_axtree_txt":2700,"n_token_pruned_html":20742,"n_token_agent_messages":4333},"result":{"status":"failed","error":"TimeoutError: Timeout 500ms exceeded.\\n=========================== logs ===========================\\nwaiting for get_by_test_id(\\"698\\")\\n  locator resolved to <span bid=\\"698\\" class=\\"changed\\" browsergym_set_of_mark…></span>\\nattempting click action\\n  waiting for element to be visible, enabled and stable\\n    element is not visible - waiting...\\n============================================================"}},{"id":20,"description":"select_option(\'a51\', \'Jan 2023\')\\nclick(\'696\')","thought":"The goal is to find the top-3 best-selling products in Jan 2023. From the current page, I see that the best-selling products are displayed in a table. However, the table does not show the sales data for January 2023. I need to select the \'Jan 2023\' option from the date dropdown menu to get the correct data.\\n\\nThe previous action resulted in a timeout error, so I need to try a different approach. Instead of clicking on the \'696\' element, I will try to select the \'Jan 2023\' option from the date dropdown menu.","memory":null,"actions_to_be_performed":["select_option(\'a51\',\'Jan 2023\')\\nclick(\'696\')"],"stats":{"n_token_dom_txt":36183,"n_token_axtree_txt":2700,"n_token_pruned_html":20742,"n_token_agent_messages":4517},"result":{"status":"failed","error":"ValueError: Could not find element with bid \\"a51\\""}},{"id":26,"description":"click(\'652\')\\nselect_option(\'a51\', \'Jan 2023\')\\nclick(\'696\')","thought":"From the AXTree, I can see that the current page is the \\"Dashboard\\" of the Magento Admin Panel. The user wants to know the top-3 best-selling products in Jan 2023. I need to find a way to select the month and year, and then find the best-selling products. I notice that there is a tab called \\"Bestsellers\\" which seems to be what the user is looking for. However, the tab is currently disabled and has a message saying that the information is invalid.\\n\\nI see that there is a button called \\"Reload Data\\" which might refresh the page and enable the tab. I also see that there is a dropdown menu with the option \\"Jan 2023\\" which might be used to select the month and year.\\n\\nI\'ll try to click on the \\"Reload Data\\" button to see if it enables the tab and then select the month and year to get the correct data.","memory":null,"actions_to_be_performed":["click(\'652\')\\nselect_option(\'a51\',\'Jan 2023\')\\nclick(\'696\')"],"stats":{"n_token_dom_txt":36183,"n_token_axtree_txt":2700,"n_token_pruned_html":20742,"n_token_agent_messages":4566},"result":{"status":"failed","error":"ValueError: Could not find element with bid \\"a51\\""}},{"id":33,"description":"click(\'696\')\\nselect_option(\'a51\',\'Jan 2023\')\\nclick(\'696\')","thought":"The goal is to find the top-3 best-selling products in Jan 2023. The current tab is \'The information in this tab has been changed. This tab contains invalid data. Please resolve this before saving. Loading... Bestsellers\'. However, it seems that the page is loading and the data is not yet available. The previous actions failed to select the option \'Jan 2023\' from the dropdown because it was not visible. We should try to select the option after the page has finished loading.","memory":null,"actions_to_be_performed":["click(\'696\')\\nselect_option(\'a51\',\'Jan 2023\')\\nclick(\'696\')"],"stats":{"n_token_dom_txt":36252,"n_token_axtree_txt":2717,"n_token_pruned_html":20817,"n_token_agent_messages":4707},"result":{"status":"failed","error":"ValueError: Could not find element with bid \\"a51\\""}},{"id":36,"description":"click(\'652\') # click on the dropdown menu for the date filter\\nselect_option(\'a51\',\'Jan 2023\') # select the option for January 2023\\nclick(\'696\') # click on the \'Apply\' button to apply the date filter","thought":"Since the goal is to find the top-3 best-selling products in Jan 2023, I need to find a way to select the correct month and year for the report. However, there is an error in the previous actions that indicates the element with bid \\"a51\\" could not be found. This suggests that the dropdown menu for selecting the month and year was not correctly identified or selected. I will try to find the correct dropdown menu by examining the page content and selecting the correct option for the month and year.","memory":null,"actions_to_be_performed":["click(\'652\')\\nselect_option(\'a51\',\'Jan 2023\')\\nclick(\'696\')"],"stats":{"n_token_dom_txt":36252,"n_token_axtree_txt":2717,"n_token_pruned_html":20817,"n_token_agent_messages":4627},"result":{"status":"failed","error":"TimeoutError: Timeout 495ms exceeded.\\n=========================== logs ===========================\\n  waiting for element to be stable\\n  element is stable\\n  element is not displayed, retrying in 0ms\\n  waiting for element to be stable\\n  element is stable\\n  element is not displayed, retrying in 50ms\\n  waiting for element to be stable\\n  element is stable\\n  element is not displayed, retrying in 100ms\\n  waiting for element to be stable\\n  element is stable\\n  element is not displayed, retrying in 250ms\\n============================================================"}},{"id":46,"description":"select_option(\'a51\',\'Jan 2023\')\\nclick(\'696\')","thought":"The user wants to know the top-3 best-selling product in Jan 2023. I examined the current page and saw that there is a tab named \'Bestsellers\' which seems to be related to the sales data. However, the data is not up-to-date and the tab is still loading. I also noticed that there is a dropdown menu with the label \'Scope\' which might be used to select the time period. I will try to select \'Jan 2023\' from the dropdown menu and then click on the \'Bestsellers\' tab to see the updated data.","memory":null,"actions_to_be_performed":["select_option(\'a51\',\'Jan 2023\')\\nclick(\'696\')"],"stats":{"n_token_dom_txt":36252,"n_token_axtree_txt":2717,"n_token_pruned_html":20817,"n_token_agent_messages":4864},"result":{"status":"failed","error":"ValueError: Could not find element with bid \\"a51\\""}},{"id":56,"description":"select_option(\'a52\', \'Jan 2023\')\\nclick(\'696\')","thought":"The user is asking for the top-3 best-selling products in January 2023. Looking at the current page, there is a tab called \\"Bestsellers\\" which seems to show the top-selling products. However, the user wants the top-3 best-selling products in January 2023, which means we need to filter the data by month. The previous actions have been trying to select the month \\"Jan 2023\\" from a dropdown menu, but it seems like there\'s an issue with the element with bid \\"a51\\".\\n\\nI think the issue is that the element with bid \\"a51\\" is not being found. Let me try to explore other options to select the month.","memory":null,"actions_to_be_performed":["select_option(\'a52\',\'Jan 2023\')\\nclick(\'696\')"],"stats":{"n_token_dom_txt":36252,"n_token_axtree_txt":2717,"n_token_pruned_html":20817,"n_token_agent_messages":4821},"result":{"status":"failed","error":"ValueError: Could not find element with bid \\"a52\\""}}],"tasks_for_eval":[{"id":58,"description":"select_option(\'696\', \'Jan 2023\')\\nclick(\'696\')","thought":"The goal is to find the top 3 best-selling products in January 2023. We are currently on the dashboard page of the Magento Admin Panel. We have tried to select the option \'Jan 2023\' for the \'Period\' dropdown, but it seems to be causing issues. We need to find another way to select the period or navigate to a different page that provides the required information. The table with the best-selling products is currently visible on the page, but it seems to be showing all products, not just the top 3 for January 2023.","memory":null,"actions_to_be_performed":["select_option(\'696\',\'Jan 2023\')\\nclick(\'696\')"],"stats":{"n_token_dom_txt":36252,"n_token_axtree_txt":2717,"n_token_pruned_html":20817,"n_token_agent_messages":4837},"result":null},{"id":59,"description":"click(\'704\')\\nclick(\'722\')","thought":"The goal is to find the top-3 best-selling products in Jan 2023. I have tried to click on the \'Reports\' tab and select the \'Jan 2023\' option, but it resulted in a timeout error. I also tried to select the \'Jan 2023\' option directly, but it resulted in a ValueError. I need to explore other options to get the data.\\n\\nThe current page shows various statistics and charts, but none of them seem to be related to the best-selling products. I need to find a way to access the sales reports or the product sales data.\\n\\nLooking at the page, I see a \'Reload Data\' button. Maybe clicking on this button will refresh the page and allow me to access the data I need.","memory":null,"actions_to_be_performed":["click(\'704\')\\nclick(\'722\')"],"stats":{"n_token_dom_txt":36252,"n_token_axtree_txt":2717,"n_token_pruned_html":20817,"n_token_agent_messages":4868},"result":null},{"id":60,"description":"select_option(\'a52\',\'Jan 2023\')\\nclick(\'696\')","thought":"Looking at the current state of the page, I see that there is a dropdown menu labeled \\"Scope\\" with the value \\"All Store Views\\". The user\'s previous instruction was to find the top-3 best-selling products in January 2023. I need to select the correct scope and date range to get the relevant information. However, I notice that the dropdown menu with bid \\"a51\\" was not found in the previous actions. I will try to select the \\"Jan 2023\\" option from the dropdown menu with bid \\"a52\\", which is a part of the \\"Advanced Reporting\\" section.","memory":null,"actions_to_be_performed":["select_option(\'a52\',\'Jan 2023\')\\nclick(\'696\')"],"stats":{"n_token_dom_txt":36252,"n_token_axtree_txt":2717,"n_token_pruned_html":20817,"n_token_agent_messages":4844},"result":null},{"id":62,"description":"select_option(\'a51\',\'Jan 2023\')\\nclick(\'696\')","thought":"The goal is to find the top-3 best-selling products in Jan 2023. Looking at the page, I see a tab called \\"Bestsellers\\" but it seems to be loading data. I also see a dropdown menu with the label \\"Scope\\" which might be related to the date. However, none of the current options in the dropdown seem to match \\"Jan 2023\\". I need to explore the dropdown menu and find the option that corresponds to \\"Jan 2023\\" in order to proceed.","memory":null,"actions_to_be_performed":["select_option(\'a51\',\'Jan 2023\')\\nclick(\'696\')"],"stats":{"n_token_dom_txt":36252,"n_token_axtree_txt":2717,"n_token_pruned_html":20817,"n_token_agent_messages":4826},"result":null},{"id":63,"description":"click(\'768\')","thought":"Looking at the current state of the page, I can see that the top-3 best-selling products in January 2023 are displayed in a table. The table has the headers \\"Product\\", \\"Price\\", and \\"Quantity\\". The products are: Sprite Stasis Ball 65 cm, Quest Lumaflex™ Band, and Overnight Duffle. However, the task requires me to find the top-3 best-selling products in January 2023, which is already displayed on the page. Therefore, I need to click on the \\"Bestsellers\\" tab to get the correct information.\\n\\nThe previous actions have been trying to select the month \\"Jan 2023\\" from a dropdown menu, but it seems that the dropdown menu is not correctly identified by the action. I will try to click on the \\"Bestsellers\\" tab instead.","memory":null,"actions_to_be_performed":["click(\'768\')"],"stats":{"n_token_dom_txt":36252,"n_token_axtree_txt":2717,"n_token_pruned_html":20817,"n_token_agent_messages":4880},"result":null},{"id":64,"description":"click(\'768\')\\nselect_option(\'a52\', \'Jan 2023\')\\nclick(\'768\')","thought":"The user wants to get the top-3 best-selling products in Jan 2023. I noticed that the current page is the dashboard, and there is a tab \\"Bestsellers\\" which seems relevant. However, the tab is disabled and says \\"Loading...\\". I need to figure out how to enable this tab and get the information.\\n\\nFrom the error logs, I see that the previous actions failed to select the option \\"Jan 2023\\" because it couldn\'t find the element with bid \\"a51\\". I also noticed that the current tab \\"Bestsellers\\" is not the selected tab, so I need to select it.\\n\\nI will try to select the tab \\"Bestsellers\\" and then select the option \\"Jan 2023\\" to get the correct data.","memory":null,"actions_to_be_performed":["click(\'768\')\\nselect_option(\'a52\',\'Jan 2023\')\\nclick(\'768\')"],"stats":{"n_token_dom_txt":36252,"n_token_axtree_txt":2717,"n_token_pruned_html":20817,"n_token_agent_messages":4884},"result":null}]}'}, {'role': 'user', 'content': '{"current_page_url":"http://nlp-in-477-l.soe.ucsc.edu:7780/admin/admin/dashboard/","current_page_dom":"RootWebArea \'Dashboard / Magento Admin\', focused\\n\\t[148] link \'Magento Admin Panel\'\\n\\t\\t[149] image \'Magento Admin Panel\'\\n\\t[150] navigation \'\'\\n\\t\\t[151] menubar \'\', orientation=\'horizontal\'\\n\\t\\t\\t[153] link \'\\\\ue604 DASHBOARD\'\\n\\t\\t\\t[156] link \'\\\\ue60b SALES\'\\n\\t\\t\\t[189] link \'\\\\ue608 CATALOG\'\\n\\t\\t\\t[207] link \'\\\\ue603 CUSTOMERS\'\\n\\t\\t\\t[226] link \'\\\\ue609 MARKETING\'\\n\\t\\t\\t[293] link \'\\\\ue602 CONTENT\'\\n\\t\\t\\t[339] link \'\\\\ue60a REPORTS\'\\n\\t\\t\\t[464] link \'\\\\ue60d STORES\'\\n\\t\\t\\t[540] link \'\\\\ue610 SYSTEM\'\\n\\t\\t\\t[623] link \'\\\\ue612 FIND PARTNERS & EXTENSIONS\'\\n\\t[645] button \'System Messages: 1\'\\n\\tStaticText \'\\\\ue623\'\\n\\tStaticText \'Failed to synchronize data to the Magento Business Intelligence service.\'\\n\\t[651] link \'Retry Synchronization\'\\n\\t[661] banner \'\'\\n\\t\\t[664] heading \'Dashboard\'\\n\\t\\t[667] link \'\\\\ue600 admin\'\\n\\t\\t[679] link \'\\\\ue607\'\\n\\t\\t[681] Section \'\'\\n\\t\\t\\t[683] LabelText \'\'\\n\\t\\t\\t\\tStaticText \'\\\\ue60c\'\\n\\t\\t\\t[687] textbox \'\\\\ue60c\'\\n\\t[693] main \'\'\\n\\t\\tStaticText \'Scope:\'\\n\\t\\t[704] button \'All Store Views\', hasPopup=\'menu\'\\n\\t\\t[715] link \'\\\\ue633 What is this?\'\\n\\t\\t[720] Section \'\'\\n\\t\\t\\t[722] button \'Reload Data\'\\n\\t\\tStaticText \'\\\\ue62d\'\\n\\t\\tStaticText \'We updated lifetime statistic.\'\\n\\t\\t[730] Section \'\'\\n\\t\\t\\t[732] HeaderAsNonLandmark \'\'\\n\\t\\t\\t\\tStaticText \'Advanced Reporting\'\\n\\t\\t\\tStaticText \\"Gain new insights and take command of your business\' performance, using our dynamic product, order, and customer reports tailored to your customer data.\\"\\n\\t\\t\\t[735] link \'Go to Advanced Reporting \\\\ue644\'\\n\\t\\tStaticText \'Chart is disabled. To enable the chart, click\'\\n\\t\\t[742] link \'here\'\\n\\t\\tStaticText \'.\'\\n\\t\\t[745] list \'\'\\n\\t\\t\\t[746] listitem \'\'\\n\\t\\t\\t\\tStaticText \'Revenue\'\\n\\t\\t\\t\\t[748] strong \'\'\\n\\t\\t\\t\\t\\tStaticText \'$0.00\'\\n\\t\\t\\t[751] listitem \'\'\\n\\t\\t\\t\\tStaticText \'Tax\'\\n\\t\\t\\t\\t[753] strong \'\'\\n\\t\\t\\t\\t\\tStaticText \'$0.00\'\\n\\t\\t\\t[756] listitem \'\'\\n\\t\\t\\t\\tStaticText \'Shipping\'\\n\\t\\t\\t\\t[758] strong \'\'\\n\\t\\t\\t\\t\\tStaticText \'$0.00\'\\n\\t\\t\\t[761] listitem \'\'\\n\\t\\t\\t\\tStaticText \'Quantity\'\\n\\t\\t\\t\\t[763] strong \'\'\\n\\t\\t\\t\\t\\tStaticText \'0\'\\n\\t\\t[767] tablist \'\', multiselectable=False, orientation=\'horizontal\'\\n\\t\\t\\t[768] tab \'The information in this tab has been changed. This tab contains invalid data. Please resolve this before saving. Loading... Bestsellers\', expanded=True, selected=True, controls=\'grid_tab_ordered_products_content\'\\n\\t\\t\\t\\t[769] link \'The information in this tab has been changed. This tab contains invalid data. Please resolve this before saving. Loading... Bestsellers\'\\n\\t\\t\\t[775] tab \'The information in this tab has been changed. This tab contains invalid data. Please resolve this before saving. Loading... Most Viewed Products\', expanded=False, selected=False, controls=\'ui-id-1\'\\n\\t\\t\\t\\t[776] link \'The information in this tab has been changed. This tab contains invalid data. Please resolve this before saving. Loading... Most Viewed Products\'\\n\\t\\t\\t[783] tab \'The information in this tab has been changed. This tab contains invalid data. Please resolve this before saving. Loading... New Customers\', expanded=False, selected=False, controls=\'ui-id-2\'\\n\\t\\t\\t\\t[784] link \'The information in this tab has been changed. This tab contains invalid data. Please resolve this before saving. Loading... New Customers\'\\n\\t\\t\\t[791] tab \'The information in this tab has been changed. This tab contains invalid data. Please resolve this before saving. Loading... Customers\', expanded=False, selected=False, controls=\'ui-id-3\'\\n\\t\\t\\t\\t[792] link \'The information in this tab has been changed. This tab contains invalid data. Please resolve this before saving. Loading... Customers\'\\n\\t\\t[801] tabpanel \'The information in this tab has been changed. This tab contains invalid data. Please resolve this before saving. Loading... Bestsellers\'\\n\\t\\t\\t[803] table \'\'\\n\\t\\t\\t\\t[804] rowgroup \'\'\\n\\t\\t\\t\\t\\t[805] row \'\'\\n\\t\\t\\t\\t\\t\\t[806] columnheader \'Product\'\\n\\t\\t\\t\\t\\t\\t[808] columnheader \'Price\'\\n\\t\\t\\t\\t\\t\\t[810] columnheader \'Quantity\'\\n\\t\\t\\t\\t[812] rowgroup \'\'\\n\\t\\t\\t\\t\\t[813] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/catalog/product/edit/id/29/\'\\n\\t\\t\\t\\t\\t\\t[814] gridcell \'Sprite Stasis Ball 65 cm\'\\n\\t\\t\\t\\t\\t\\t[815] gridcell \'$27.00\'\\n\\t\\t\\t\\t\\t\\t[816] gridcell \'6\'\\n\\t\\t\\t\\t\\t[817] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/catalog/product/edit/id/20/\'\\n\\t\\t\\t\\t\\t\\t[818] gridcell \'Quest Lumaflex™ Band\'\\n\\t\\t\\t\\t\\t\\t[819] gridcell \'$19.00\'\\n\\t\\t\\t\\t\\t\\t[820] gridcell \'6\'\\n\\t\\t\\t\\t\\t[821] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/catalog/product/edit/id/13/\'\\n\\t\\t\\t\\t\\t\\t[822] gridcell \'Overnight Duffle\'\\n\\t\\t\\t\\t\\t\\t[823] gridcell \'$45.00\'\\n\\t\\t\\t\\t\\t\\t[824] gridcell \'5\'\\n\\t\\t\\t\\t\\t[825] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/catalog/product/edit/id/25/\'\\n\\t\\t\\t\\t\\t\\t[826] gridcell \'Sprite Stasis Ball 55 cm\'\\n\\t\\t\\t\\t\\t\\t[827] gridcell \'$23.00\'\\n\\t\\t\\t\\t\\t\\t[828] gridcell \'5\'\\n\\t\\t\\t\\t\\t[829] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/catalog/product/edit/id/33/\'\\n\\t\\t\\t\\t\\t\\t[830] gridcell \'Sprite Yoga Strap 6 foot\'\\n\\t\\t\\t\\t\\t\\t[831] gridcell \'$14.00\'\\n\\t\\t\\t\\t\\t\\t[832] gridcell \'5\'\\n\\t\\tStaticText \'Lifetime Sales\'\\n\\t\\t[840] strong \'\'\\n\\t\\t\\tStaticText \'$0.00\'\\n\\t\\tStaticText \'Average Order\'\\n\\t\\t[846] strong \'\'\\n\\t\\t\\tStaticText \'$0.00\'\\n\\t\\tStaticText \'Last Orders\'\\n\\t\\t[852] table \'\'\\n\\t\\t\\t[853] rowgroup \'\'\\n\\t\\t\\t\\t[854] row \'\'\\n\\t\\t\\t\\t\\t[855] columnheader \'Customer\'\\n\\t\\t\\t\\t\\t[857] columnheader \'Items\'\\n\\t\\t\\t\\t\\t[859] columnheader \'Total\'\\n\\t\\t\\t[861] rowgroup \'\'\\n\\t\\t\\t\\t[862] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/sales/order/view/order_id/299/\'\\n\\t\\t\\t\\t\\t[863] gridcell \'Sarah Miller\'\\n\\t\\t\\t\\t\\t[864] gridcell \'5\'\\n\\t\\t\\t\\t\\t[865] gridcell \'$194.40\'\\n\\t\\t\\t\\t[866] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/sales/order/view/order_id/65/\'\\n\\t\\t\\t\\t\\t[867] gridcell \'Grace Nguyen\'\\n\\t\\t\\t\\t\\t[868] gridcell \'4\'\\n\\t\\t\\t\\t\\t[869] gridcell \'$190.00\'\\n\\t\\t\\t\\t[870] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/sales/order/view/order_id/125/\'\\n\\t\\t\\t\\t\\t[871] gridcell \'Matt Baker\'\\n\\t\\t\\t\\t\\t[872] gridcell \'3\'\\n\\t\\t\\t\\t\\t[873] gridcell \'$151.40\'\\n\\t\\t\\t\\t[874] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/sales/order/view/order_id/136/\'\\n\\t\\t\\t\\t\\t[875] gridcell \'Lily Potter\'\\n\\t\\t\\t\\t\\t[876] gridcell \'4\'\\n\\t\\t\\t\\t\\t[877] gridcell \'$188.20\'\\n\\t\\t\\t\\t[878] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/sales/order/view/order_id/230/\'\\n\\t\\t\\t\\t\\t[879] gridcell \'Ava Brown\'\\n\\t\\t\\t\\t\\t[880] gridcell \'2\'\\n\\t\\t\\t\\t\\t[881] gridcell \'$83.40\'\\n\\t\\tStaticText \'Last Search Terms\'\\n\\t\\t[886] table \'\'\\n\\t\\t\\t[887] rowgroup \'\'\\n\\t\\t\\t\\t[888] row \'\'\\n\\t\\t\\t\\t\\t[889] columnheader \'Search Term\'\\n\\t\\t\\t\\t\\t[891] columnheader \'Results\'\\n\\t\\t\\t\\t\\t[893] columnheader \'Uses\'\\n\\t\\t\\t[895] rowgroup \'\'\\n\\t\\t\\t\\t[896] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/search/term/edit/id/13/\'\\n\\t\\t\\t\\t\\t[897] gridcell \'100\'\\n\\t\\t\\t\\t\\t[898] gridcell \'23\'\\n\\t\\t\\t\\t\\t[899] gridcell \'2\'\\n\\t\\t\\t\\t[900] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/search/term/edit/id/25/\'\\n\\t\\t\\t\\t\\t[901] gridcell \'tanks\'\\n\\t\\t\\t\\t\\t[902] gridcell \'23\'\\n\\t\\t\\t\\t\\t[903] gridcell \'1\'\\n\\t\\t\\t\\t[904] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/search/term/edit/id/19/\'\\n\\t\\t\\t\\t\\t[905] gridcell \'nike\'\\n\\t\\t\\t\\t\\t[906] gridcell \'0\'\\n\\t\\t\\t\\t\\t[907] gridcell \'3\'\\n\\t\\t\\t\\t[908] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/search/term/edit/id/1/\'\\n\\t\\t\\t\\t\\t[909] gridcell \'Joust Bag\'\\n\\t\\t\\t\\t\\t[910] gridcell \'10\'\\n\\t\\t\\t\\t\\t[911] gridcell \'4\'\\n\\t\\t\\t\\t[912] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/search/term/edit/id/11/\'\\n\\t\\t\\t\\t\\t[913] gridcell \'hollister\'\\n\\t\\t\\t\\t\\t[914] gridcell \'1\'\\n\\t\\t\\t\\t\\t[915] gridcell \'19\'\\n\\t\\tStaticText \'Top Search Terms\'\\n\\t\\t[920] table \'\'\\n\\t\\t\\t[921] rowgroup \'\'\\n\\t\\t\\t\\t[922] row \'\'\\n\\t\\t\\t\\t\\t[923] columnheader \'Search Term\'\\n\\t\\t\\t\\t\\t[925] columnheader \'Results\'\\n\\t\\t\\t\\t\\t[927] columnheader \'Uses\'\\n\\t\\t\\t[929] rowgroup \'\'\\n\\t\\t\\t\\t[930] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/search/term/edit/id/11/\'\\n\\t\\t\\t\\t\\t[931] gridcell \'hollister\'\\n\\t\\t\\t\\t\\t[932] gridcell \'1\'\\n\\t\\t\\t\\t\\t[933] gridcell \'19\'\\n\\t\\t\\t\\t[934] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/search/term/edit/id/1/\'\\n\\t\\t\\t\\t\\t[935] gridcell \'Joust Bag\'\\n\\t\\t\\t\\t\\t[936] gridcell \'10\'\\n\\t\\t\\t\\t\\t[937] gridcell \'4\'\\n\\t\\t\\t\\t[938] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/search/term/edit/id/13/\'\\n\\t\\t\\t\\t\\t[939] gridcell \'100\'\\n\\t\\t\\t\\t\\t[940] gridcell \'23\'\\n\\t\\t\\t\\t\\t[941] gridcell \'2\'\\n\\t\\t\\t\\t[942] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/search/term/edit/id/25/\'\\n\\t\\t\\t\\t\\t[943] gridcell \'tanks\'\\n\\t\\t\\t\\t\\t[944] gridcell \'23\'\\n\\t\\t\\t\\t\\t[945] gridcell \'1\'\\n\\t\\t\\t\\t[946] row \'http://nlp-in-477-l.soe.ucsc.edu:7780/admin/search/term/edit/id/9/\'\\n\\t\\t\\t\\t\\t[947] gridcell \'WP10\'\\n\\t\\t\\t\\t\\t[948] gridcell \'1\'\\n\\t\\t\\t\\t\\t[949] gridcell \'1\'\\n\\t[951] contentinfo \'\'\\n\\t\\t[954] paragraph \'\'\\n\\t\\t\\t[955] link \'\\\\ue606\'\\n\\t\\t\\tStaticText \'Copyright © 2024 Magento Commerce Inc. All rights reserved.\'\\n\\t\\t[957] paragraph \'\'\\n\\t\\t\\t[958] strong \'\'\\n\\t\\t\\t\\tStaticText \'Magento\'\\n\\t\\t\\tStaticText \'ver. 2.4.6\'\\n\\t\\t[959] link \'Privacy Policy\'\\n\\t\\tStaticText \'|\'\\n\\t\\t[960] link \'Account Activity\'\\n\\t\\tStaticText \'|\'\\n\\t\\t[961] link \'Report an Issue\'"}'}]
    
    start = time()

    r = client.chat.completions.create(
        model=model,
        messages=payload,
        temperature=temperature,
        # n=3,
        # logprobs=True,
        # top_logprobs=3,  
    )
    print(
        f"\nTime taken: {time() - start:.2f}s, response: {r.choices[0].message.content}"
    )

    start = time()
    # client = instructor.from_openai(client, 
    #                                 # mode=Mode.JSON
    #                                 ) # see: refer to https://github.com/instructor-ai/instructor/discussions/806
    response = client.beta.chat.completions.parse(
        model=model,
        messages=payload,
        response_format=AgentQCriticOutput,
        temperature=temperature,
        # max_retries=1,
        n=3,
        logprobs=True,
        top_logprobs=3,  
    )
    print(
        f"\nTime taken: {time() - start:.2f}s, response: {response.model_dump_json()}"
    )
